---
id: ARCH-data-management
title: "Управление тестовыми данными, окружениями и секретами"
type: feature
layer: application
owner: '@architect'
version: v3
status: planned
created: 2024-07-29
updated: 2025-11-21
tags: [test-data, environment, secrets, ai, planner, resolver]
depends_on: [ARCH-data-model]
referenced_by: []
---
## Контекст
Для обеспечения гибкости и переиспользуемости тестов система предоставляет механизмы управления тестовыми данными, конфигурациями окружений и безопасного хранения секретов, а также интеллектуальной генерации данных.

## Структура
*   **`TestDataSet`**: Сущность для хранения наборов тестовых данных.
*   **`Environment`**: Сущность, определяющая набор подключений к SUT для конкретного стенда.
*   **`TenantSecret`**: Сущность для безопасного хранения чувствительных данных (пароли, токены).

### Управление Секретами (Dynamic Secrets)
Система поддерживает динамическое разрешение секретов в момент выполнения теста (Runtime Resolution).
*   **Хранение:** Секреты хранятся в таблице `tenant_secrets`. В MVP значения хранятся в открытом виде (или Base64), в Production-ready версии — шифруются симметричным ключом (AES-256) на уровне приложения.
*   **Синтаксис:** В настройках подключений (например, `DbConnectionProfile`) используются плейсхолдеры вида `{{secret.MY_DB_PASSWORD}}`.
*   **Разрешение:** Компонент `SecretProvider` в `orchestra-executor` перед установкой соединения парсит строку, извлекает ключ секрета, находит его значение в БД для текущего тенанта и подставляет в строку подключения.

### Паттерн "Planner + Resolver" для AI-генерации
Система использует продвинутый паттерн для генерации контекстно-зависимых данных:
*   **`ai-service` (Planner)**: Принимает бизнес-контекст и генерирует **`DataPlan`** — структурированные требования к данным (например, "нужен клиент из сегмента 'retail'").
*   **`Data Resolver` (Tool в `orchestra-api`)**: Принимает `DataPlan` и выполняет детерминированные запросы (SQL, семантический поиск через PGVector) к тестовой БД для извлечения **реальных** данных, удовлетворяющих требованиям.
*   **RAG (Retrieval-Augmented Generation)**: `Data Resolver` использует PGVector для выполнения семантических запросов, "заземляя" генерацию в реальных данных.

## Поведение
1.  **Параметризация:** При запуске теста `Execution Engine` использует `TestDataSet` для подстановки значений в плейсхолдеры (`{{data.user.id}}`).
2.  **Разрешение подключений:** `Execution Engine` использует `Environment` для разрешения алиасов (`main_db`) в конкретные профили подключений и безопасного извлечения секретов.
3.  **AI-генерация:** Пользователь инициирует генерацию. `orchestra-api` вызывает `ai-service` для получения `DataPlan`. Затем `Data Resolver` исполняет этот план и возвращает готовый, валидный `TestDataSet`.
