---
id: ARCH-data-model
title: "Ключевые сущности домена"
type: data_model
layer: domain
owner: '@architect'
version: v2
status: planned
created: 2024-07-29
updated: 2024-07-30
tags: [domain, entity, postgres, jsonb, durable-workflow]
depends_on: []
referenced_by: []
---
## Контекст
Этот документ описывает основные сущности доменной модели Orchestra. Модель спроектирована так, чтобы быть независимой от конкретных протоколов и обеспечивать гибкость за счет использования JSONB для хранения динамических данных. Она также включает поля, необходимые для реализации отказоустойчивого `Durable Workflow` и оркестрации наборов сценариев.

## Структура

### Основные сущности
*   **`Process`**: Представление бизнес-процесса, импортированного из BPMN.
*   **`ScenarioSuite`**: Набор тестовых сценариев (`TestScenario`), покрывающих один `Process`.
*   **`TestScenario`**: Упорядоченная последовательность шагов (`ScenarioStep`), представляющая один конкретный путь выполнения бизнес-процесса.
*   **`ScenarioStep`**: Атомарное действие (`ACTION`), проверка (`ASSERTION`) или точка синхронизации (`BARRIER`) в рамках сценария.
*   **`TestRun`**: Экземпляр выполнения одного `TestScenario`.
*   **`TestDataSet`**: Именованный набор тестовых данных для параметризации.
*   **`Environment`**: Конфигурация окружения для подключения к SUT.

В качестве основного хранилища используется **PostgreSQL**. Ключевые связи являются реляционными, а гибкие структуры (тело запроса, результаты) хранятся в полях `JSONB`.

### Сущности и поля для поддержки продвинутых 워크플로우

Для реализации отказоустойчивости, асинхронности и зависимостей, базовые сущности расширены:

*   **`SuiteRun` (Новая сущность):**
    *   Представляет собой запуск целого `ScenarioSuite`.
    *   Хранит общий статус (`IN_PROGRESS`, `PASSED`, `FAILED`).
    *   Содержит поле `context: JSONB` — общее хранилище данных, доступное всем `TestScenario` внутри этого `SuiteRun` (для передачи данных между сценариями).

*   **`TestRun` (Расширенная сущность):**
    *   `suiteRunId`: Внешний ключ, связывающий `TestRun` с родительским `SuiteRun`.
    *   `status`: Расширен новыми значениями `PENDING` (ожидает планировщика), `QUEUED` (в очереди), `FAILED_STUCK` (завис).
    *   **Поля для Durable Workflow (`ADR-0020`):**
        *   `execution_context: JSONB`: Персистентный контекст выполнения, хранящий переменные и результаты предыдущих шагов.
        *   `locked_by`, `lock_until`: Поля для реализации механизма "аренды" (lease), предотвращающего выполнение одной задачи несколькими воркерами.
        *   `heartbeat_at`: Timestamp, который воркер периодически обновляет, показывая, что он "жив".

*   **`TestScenario` (Расширенная сущность):**
    *   `dependsOn: JSONB`: Описывает зависимости от других сценариев в рамках `SuiteRun` (например, запускаться только после успешного завершения другого сценария).

*   **`ScenarioStep` (Расширенная сущность):**
    *   `kind`: Enum расширен значением `BARRIER` для синхронизации параллельных веток.
    *   `meta.exportAs: JSONB`: Позволяет шагу экспортировать часть своего результата в общий `SuiteRun.context` для использования в зависимых сценариях.

## Поведение
Эти расширения позволяют реализовать сложные паттерны:
-   **Отказоустойчивость:** При сбое воркера новый экземпляр может "арендовать" `TestRun`, восстановить его `execution_context` из БД и продолжить выполнение с прерванного места.
-   **Оркестрация:** `Scheduler` анализирует `TestScenario.dependsOn` для построения графа выполнения и запускает сценарии в правильном порядке.
-   **Сквозное тестирование:** Данные (например, `orderId`) могут быть созданы в одном сценарии, экспортированы в `SuiteRun.context` и использованы в другом сценарии (например, для отмены этого же заказа).
