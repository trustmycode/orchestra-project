---
id: ARCH-execution-engine
title: "Движок исполнения тестов (Execution Engine)"
type: component
layer: application
owner: '@architect'
version: v1
status: planned
created: 2024-07-29
updated: 2024-07-29
tags: [executor, worker, rabbitmq, async]
depends_on: [ARCH-core-services, ARCH-protocol-plugins]
referenced_by: []
---
## Контекст
Движок исполнения (Execution Engine) является ядром системы, отвечающим за асинхронное, масштабируемое и отказоустойчивое выполнение тестовых сценариев. Он реализован на базе паттерна "Очередь задач" с использованием брокера сообщений RabbitMQ и сервисов-воркеров `orchestra-executor`.

## Структура
*   **Очередь задач (Task Queue)**: В RabbitMQ создается очередь для задач на выполнение тестов (например, `test_runs_queue`).
*   **Очередь "мертвых писем" (DLQ)**: Настраивается для обработки сбойных сообщений, которые не удалось обработать воркерам.
*   **Продюсер (`orchestra-api`)**: При запуске теста сервис `orchestra-api` создает `TestRun` в БД со статусом `QUEUED` и публикует сообщение с `runId` в очередь задач.
*   **Консьюмер (`orchestra-executor`)**: Один или несколько экземпляров сервиса `orchestra-executor` подписываются на очередь, забирают сообщения, обрабатывают их и обновляют статус `TestRun` в БД.

## Поведение
1.  Запуск теста через API инициирует создание сообщения в RabbitMQ.
2.  Свободный воркер `orchestra-executor` забирает сообщение и подтверждает его получение (ack).
3.  Воркер меняет статус `TestRun` на `IN_PROGRESS`.
4.  Шаги сценария выполняются последовательно. Для каждого шага вызывается соответствующий `ProtocolPlugin`.
5.  Результаты каждого шага записываются в БД.
6.  После завершения всех шагов (или при ошибке) итоговый статус `TestRun` обновляется в БД.
7.  Если воркер падает во время обработки, сообщение (благодаря механизму ack) вернется в очередь для повторной обработки другим воркером.

## Эволюция
### Планируемые изменения
— Внедрение политик повторных попыток (retry) с экспоненциальной задержкой для обработки временных сбоев.
— Разделение на несколько очередей с разными приоритетами для срочных и фоновых задач.
