---
id: TASK-2024-133
title: "Задача 4.10.11 (Backend): Двухфазная генерация данных (Global Context Extraction)"
status: todo
priority: high
type: architecture
estimate: 16h
created: 2025-11-21
parents: [TASK-2024-037]
dependencies: [TASK-2024-130]
---

## Описание
Для обеспечения целостности данных в больших сценариях и снижения нагрузки на LLM, необходимо внедрить механизм предварительного выделения общих параметров.

Вместо того чтобы генерировать данные последовательно и надеяться, что AI "вспомнит" ID из первого шага на пятидесятом, мы явно выделяем эти ID в глобальный контекст перед генерацией тел запросов.

## Алгоритм (Two-Pass Strategy)

1.  **Phase 1: Variable Extraction (Агент-Аналитик)**
    *   Вход: Список всех шагов (только метаданные: `alias`, `name`, ключи из `inputTemplate`/`sql`).
    *   Промпт: "Analyze the scenario flow. Identify shared entities (IDs, keys) that connect these steps. Return a list of GLOBAL VARIABLES."
    *   Выход: JSON-схема глобальных переменных (например, `MAIN_USER_ID`, `TARGET_PRODUCT_ID`).

2.  **Phase 2: Global Resolution (Агент-Планировщик + Resolver)**
    *   Генерация значений для этих переменных (с использованием `DataResolver` для поиска в БД).
    *   Результат: `GlobalContext = { "MAIN_USER_ID": "uuid-1", "TARGET_PRODUCT_ID": "iphone" }`.

3.  **Phase 3: Step Generation (Агент-Генератор)**
    *   Запуск генерации данных для шагов (можно параллельно батчами).
    *   В каждый запрос передается `GlobalContext` как **Immutable Reference**.
    *   Инструкция: "Fill the step data. MUST use values from Global Context for corresponding fields."

## Преимущества
*   **Параллелизация:** Шаг 50 не ждет Шага 49, так как оба зависят только от Глобального Контекста.
*   **Экономия токенов:** В контексте висят только 5-10 глобальных переменных, а не мегабайты JSON-ов всех предыдущих шагов.
*   **Стабильность:** ID гарантированно совпадают.

## Критерии приемки
- [ ] Реализован сервис `ScenarioAnalyzer`, который вызывает AI для выделения переменных.
- [ ] Реализован флоу: Анализ -> Генерация Глобальных Переменных -> Генерация Шагов.
- [ ] Тест на сценарии из 10 шагов показывает, что ID, сгенерированный для 1-го шага, используется в 10-м шаге идентично.