---
id: TASK-2024-085
title: "Задача 4.8.1 (Backend): Модель данных для лимитов и изменение API"
status: backlog
priority: high
type: task
estimate: 8h
created: 2024-07-30
parents: [TASK-2024-084]
arch_refs: [ADR-0020]
---
## Описание
Подготовить базу данных и API для работы планировщика. Это включает создание таблиц для хранения лимитов и изменение логики создания `TestRun` в соответствии с `ADR-0020`, где `Scheduler` берёт на себя принятие решений о запуске.

## Ключевые шаги
1. **Модель данных:**
   - Создать JPA-сущность и миграцию БД для таблицы `tenant_settings` (или расширить существующую `tenants`), добавив поля `max_parallel_runs`, `max_queued_runs` и т.д.
   - Добавить в `test_runs` поле `priority` (например, `integer`), чтобы различать запуски от UI (высокий приоритет) и CI (низкий).
2. **Изменение API:**
   - Модифицировать `TestRunService` и `SuiteRunService`. При создании `TestRun` (как одиночного, так и в составе `SuiteRun`) он должен сохраняться в БД со статусом **`PENDING`**, а не `QUEUED`.
   - Убрать из этих сервисов логику немедленной отправки сообщения в RabbitMQ.

## Критерии приемки
- В схеме БД есть таблица/поля для хранения лимитов по тенантам.
- Вызов `POST /testruns` или `POST /suite-runs` создает `TestRun`'ы со статусом `PENDING` и не отправляет сообщений в очередь.
- Обновлённые контракты описаны в документации по реализации ADR.
