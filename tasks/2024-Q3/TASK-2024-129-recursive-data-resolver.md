---
id: TASK-2024-129
title: "Задача 4.10.6 (Backend): Реализация рекурсивного обхода в DataResolverService"
status: todo
priority: high
type: feature
estimate: 6h
created: 2025-11-21
parents: [TASK-2024-072]
dependencies: [TASK-2024-073]
arch_refs: [ADR-0019]
---

## Описание
Текущая реализация `DataResolverService` обрабатывает только ключи верхнего уровня JSON-структуры. Если поле, требующее резолвинга (например, `admin_user`), находится внутри вложенного объекта (например, `body`), резолвер его игнорирует.

Необходимо рефакторить метод `resolve`, внедрив рекурсивный обход дерева данных (Map и List), чтобы находить и резолвить сущности на любой глубине вложенности.

## Проблема
Сценарий:
```json
{ "body": { "admin_user": "" } }
```

Текущее поведение: Резолвер проверяет ключ `body`, не находит для него правила и возвращает объект как есть.
Ожидаемое поведение: Резолвер заходит внутрь `body`, находит `admin_user`, находит для него правило в БД и подставляет UUID.

## Ключевые шаги

1.  **Рефакторинг `resolve`:**
    *   Преобразовать основной цикл в рекурсивный метод `resolveNode(String key, Object value, Environment env)`.

2.  **Логика обхода (Traversal Logic):**
    *   **Если `value` это Map:** Рекурсивно вызвать `resolveNode` для каждого элемента карты. Собрать результаты в новую Map.
    *   **Если `value` это List:** Пройтись по списку, рекурсивно вызывая обработку для каждого элемента.
    *   **Если `value` это Leaf (Примитив/Строка):** Проверить, есть ли в БД (`data_resolvers`) правило для текущего ключа (`key`).
        *   *Если есть:* Выполнить SQL-запрос (существующая логика `executeSqlResolution`).
        *   *Если нет:* Вернуть значение как есть.

3.  **Обработка SQL-инструкций от AI:**
    *   Учесть, что AI может вернуть не просто ключ, а явную инструкцию: `{"admin_user": {"dataSource": "db", "sql": "..."}}`. Эта логика уже есть, но она должна работать и на глубине.

## Критерии приемки

- [ ] Написан Unit-тест с вложенной структурой JSON (минимум 2 уровня вложенности).
- [ ] Тест подтверждает, что поле `admin_user` внутри `body` успешно заменяется на данные из мока БД.
- [ ] Сквозной тест (через API) с реальной БД возвращает UUID для вложенных полей.