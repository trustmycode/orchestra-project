---
id: TASK-2024-136
title: "Задача 5.1.8 (Full Stack): Визуализация промежуточных этапов генерации (Glass Box)"
status: todo
priority: medium
type: feature
estimate: 12h
created: 2025-11-21
parents: [TASK-2024-108]
dependencies: [TASK-2024-131, TASK-2024-132]
---

## Описание
Пользователь хочет видеть промежуточные результаты генерации данных ("мысли" AI, найденные переменные, промежуточные JSON), а не просто спиннер загрузки. Это повышает доверие к системе и помогает в отладке (понять, на каком этапе AI ошибся).

Необходимо превратить процесс генерации из "Черного ящика" в "Стеклянный ящик".

## Техническое решение (Backend)

1.  **Расширение модели `AiJob`:**
    *   Добавить поле `List<JobEvent> events`.
    *   Структура `JobEvent`:
        ```java
        record JobEvent(
            String stage,       // "ANALYSIS", "RESOLVER", "GENERATION"
            String description, // "Found 3 shared variables"
            Object data,        // JSON payload (промежуточный результат)
            LocalDateTime timestamp
        ) {}
        ```

2.  **Публикация событий в `AiService`:**
    *   В процессе выполнения (внутри методов из TASK-136/137) добавлять события в Job:
        *   *После Фазы 1:* Сохранить список выделенных переменных (`GlobalContext`).
        *   *После Фазы 2:* Сохранить результат резолвинга SQL (какие ID реально нашлись).
        *   *В процессе Фазы 3:* Сохранять сгенерированные чанки данных для сценариев.

## Техническое решение (Frontend)

1.  **Обновление `AiDataGenerationModal`:**
    *   Разделить область контента на две части или добавить вкладку "Logs / Debug".
    *   Реализовать компонент `JobLogViewer`:
        *   Список этапов (Timeline).
        *   При клике на этап раскрывается JSON-вьювер (можно использовать `react-json-view`) с промежуточными данными.

2.  **UX:**
    *   Пока идет генерация, новые события появляются в списке в реальном времени (через поллинг `GET /jobs/{id}`).

## Критерии приемки
- [ ] Пользователь запускает генерацию.
- [ ] Видит лог:
    1. "Analyzing Scenario..." -> [Показать JSON переменных]
    2. "Resolving Data..." -> [Показать JSON с UUID из базы]
    3. "Generating Step 1..."
- [ ] Можно кликнуть на "Показать JSON" и увидеть, что именно нашел AI до того, как сформировал финальный ответ.