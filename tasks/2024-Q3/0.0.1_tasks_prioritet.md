Конечно. Я обновлю ваш документ по приоритезации, включив в него новые задачи по `sgr-agent-core` и скорректировав порядок выполнения AI-задач в соответствии с их новыми зависимостями.

Вот обновленная версия документа.

# Приоритезированный план выполнения задач

## 1. Принципы приоритизации

1.  **Фундамент прежде всего:** Сначала реализуются задачи, которые являются основой для всей последующей функциональности (например, асинхронный `Execution Engine`).
2.  **Высокий риск — раньше:** Наиболее сложные и архитектурно значимые изменения (Durable Workflow, RLS) выполняются в первую очередь, чтобы снизить риски на поздних этапах.
3.  **Ключевая ценность для пользователя:** Задачи, которые напрямую решают основные проблемы, описанные в ТЗ (проверка побочных эффектов, генерация сценариев), имеют высокий приоритет.
4.  **Логические зависимости:** Задачи выполняются в порядке их зависимостей (например, нельзя реализовать `Scheduler`, пока не будет асинхронного движка).

## 2. Обзор текущего состояния

- **Фазы 0, 1, 2 (Фундамент, MVP, UX):** В основном **завершены**. Текущее решение — это работающий MVP.
- **Основной фокус:** Реализация задач из **Фаз 3 и 4**, которые превратят MVP в полноценную, отказоустойчивую и интеллектуальную платформу.

## 3. Поток работ (Последовательность эпиков)

Вот рекомендуемая последовательность выполнения ключевых эпиков. Детализация по задачам — ниже.

1.  **Эпик 3.1: Отказоустойчивый Execution Engine (`TASK-2024-022`)** — **КРИТИЧЕСКИЙ.** Это главный технический долг и основа для всего остального.
2.  **Эпик 3.2 и 3.3: ASSERTION-шаги (`TASK-2024-023`, `TASK-2024-024`)** — Реализация ключевой функциональности ТЗ.
3.  **Эпик 4.1: Мультиарендная изоляция (`TASK-2024-028`)** — Фундаментальная задача по безопасности, которая должна быть решена до добавления сложных фич.
4.  **Эпик 4.8: Scheduler (`TASK-2024-084`)** — Обеспечение стабильности и справедливости в мультиарендной среде.
5.  **Эпик 4.4: Генератор сценариев (`TASK-2024-031`)** — Реализация одной из главных "умных" функций системы.
6.  **Эпик 4.10: AI-генерация данных (`TASK-2024-072`)** — Внедрение продвинутого AI для данных.
7.  **Эпик 4.6 и 4.7: Suite Runner и зависимости (`TASK-2024-056`, `TASK-2024-061`)** — Продвинутая функциональность для сквозного тестирования.
8.  **Завершающие задачи:** Остальные AI-улучшения и задачи по эксплуатации.

---

## 4. Детальный приоритезированный список задач

### Приоритет: КРИТИЧЕСКИЙ (Ближайший спринт)

Эти задачи должны быть выполнены в первую очередь, так как они разблокируют всю дальнейшую разработку.

| ID Задачи           | Название                                            | Фаза | Приоритет       | Rationale / Обоснование                                                                                                                                                                 |
| :------------------ | :-------------------------------------------------- | :--- | :-------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`TASK-2024-022`** | **Эпик: Отказоустойчивый Execution Engine**         | 3    | **Критический** | **Главный архитектурный рефакторинг.** Переход от синхронной модели к асинхронной, отказоустойчивой и масштабируемой. **Блокирует все задачи по Assertions, Scheduler и Suite Runner.** |
| `TASK-2024-048`     | Создание общего модуля `orchestra-domain`           | 3.1  | Критический     | Необходимый шаг для разделения кода между `api` и `executor`.                                                                                                                           |
| `TASK-2024-049`     | Конфигурация RabbitMQ                               | 3.1  | Критический     | Инфраструктурная основа для асинхронного движка.                                                                                                                                        |
| `TASK-2024-050`     | Реализация продюсера задач в `orchestra-api`        | 3.1  | Критический     | Изменяет API для асинхронной работы.                                                                                                                                                    |
| `TASK-2024-051`     | Реализация потребителя задач в `orchestra-executor` | 3.1  | Критический     | "Сердце" нового воркера.                                                                                                                                                                |
| `TASK-2024-052`     | Перенос логики выполнения в `orchestra-executor`    | 3.1  | Критический     | Непосредственная реализация выполнения тестов в воркере.                                                                                                                                |
| `TASK-2024-081`     | Реализация Durable Execution Context                | 3.1  | Критический     | **Ключевая задача для отказоустойчивости.** Обеспечивает сохранение состояния.                                                                                                          |
| `TASK-2024-082`     | Реализация механизма Lease и Heartbeat              | 3.1  | Критический     | Решает проблемы "зависших" задач и конкурентного доступа.                                                                                                                               |
| `TASK-2024-083`     | Обеспечение идемпотентности потребителя             | 3.1  | Критический     | Гарантирует надежность при повторной доставке сообщений.                                                                                                                                |

### Приоритет: ВЫСОКИЙ (Следующий этап после критического)

Эти задачи реализуют ключевую бизнес-ценность и обеспечивают безопасность.

| ID Задачи           | Название                                       | Фаза | Приоритет   | Rationale / Обоснование                                                                                                                  |
| :------------------ | :--------------------------------------------- | :--- | :---------- | :--------------------------------------------------------------------------------------------------------------------------------------- |
| **`TASK-2024-028`** | **Эпик: Мультиарендная изоляция (RBAC + RLS)** | 4    | **Высокий** | **Фундаментальная задача по безопасности.** Должна быть реализована до того, как система начнет обрабатывать данные нескольких клиентов. |
| `TASK-2024-093`     | Настройка RLS и ролей в PostgreSQL             | 4.1  | Высокий     | Создает "последний рубеж" защиты на уровне БД.                                                                                           |
| `TASK-2024-094`     | Реализация фильтрации на уровне приложения     | 4.1  | Высокий     | Основной механизм изоляции данных в приложении.                                                                                          |
| **`TASK-2024-025`** | **Управление окружениями и секретами**         | 3    | **Высокий** | **Необходимо для `ASSERTION`-шагов.** Без этого плагины не смогут подключаться к внешним системам (БД, Kafka).                           |
| **`TASK-2024-023`** | **Эпик: ASSERTION-шаги для БД**                | 3    | **Высокий** | **Реализация ключевого требования ТЗ** — проверка побочных эффектов. Зависит от `TASK-2024-022` и `TASK-2024-025`.                       |
| `TASK-2024-053`     | Рефакторинг для ProtocolPlugin SPI             | 3.2  | Высокий     | Создает расширяемую архитектуру для всех типов шагов.                                                                                    |
| `TASK-2024-054`     | `DbProtocolPlugin` и управление подключениями  | 3.2  | Высокий     | Базовая реализация плагина.                                                                                                              |
| `TASK-2024-055`     | Логика polling и валидации для DB-шагов        | 3.2  | Высокий     | Основная логика проверки в БД.                                                                                                           |
| **`TASK-2024-084`** | **Эпик: Scheduler для управления нагрузкой**   | 4    | **Высокий** | **Критично для мультиарендности.** Предотвращает проблему "шумного соседа" и обеспечивает справедливость.                                |
| `TASK-2024-085`     | Модель данных для лимитов и изменение API      | 4.8  | Высокий     | Подготовительный шаг для `Scheduler`.                                                                                                    |
| `TASK-2024-086`     | Реализация основной логики планировщика        | 4.8  | Высокий     | "Мозг" планировщика.                                                                                                                     |

### Приоритет: СРЕДНИЙ (Функциональное развитие)

Эти задачи добавляют основную "интеллектуальную" ценность и расширяют возможности системы. **Обратите внимание на новый порядок задач внутри AI-эпика.**

| ID Задачи                         | Название                                           | Фаза | Приоритет            | Rationale / Обоснование                                                         |
| :-------------------------------- | :------------------------------------------------- | :--- | :------------------- | :------------------------------------------------------------------------------ |
| **`TASK-2024-072`**               | **Эпик: AI-генерация данных (Planner + Resolver)** | 4    | **Средний**          | **Ключевая AI-фича.** Делает генерацию данных надежной и релевантной.           |
| `TASK-2024-097`                   | Настройка и конфигурация `sgr-agent-core`          | 4.10 | **Средний (Высший)** | **Новый фундамент для всей AI-логики.** Блокирует все остальные AI-задачи.      |
| `TASK-2024-073`                   | Реализация компонента `Data Resolver`              | 4.10 | Средний              | Основной "инструмент" для AI-агента, реализует детерминированный подбор данных. |
| `TASK-2024-098`                   | Реализация базового набора инструментов (Toolbox)  | 4.10 | Средний              | Связывает агентский фреймворк с `Data Resolver` и другой бизнес-логикой.        |
| `TASK-2024-074`                   | Адаптация `ai-service` для генерации планов        | 4.10 | Средний              | Первая бизнес-функция, использующая новую агентскую архитектуру.                |
| `TASK-2024-075` - `TASK-2024-077` | (Остальные подзадачи Planner + Resolver)           | 4.10 | Средний              | Дальнейшее развитие RAG-пайплайна.                                              |
| **`TASK-2024-031`**               | **Эпик: Генератор сценариев из BPMN**              | 4    | **Средний**          | **Ключевая "умная" фича.** Автоматизирует создание тестов.                      |
| `TASK-2024-042` - `TASK-2024-047` | (Подзадачи генератора)                             | 4.4  | Средний              | Декомпозиция основной задачи.                                                   |
| **`TASK-2024-024`**               | **Эпик: ASSERTION-шаги для Kafka**                 | 3    | **Средний**          | Расширение возможностей по проверке побочных эффектов.                          |
| `TASK-2024-080`                   | Корреляция и метрики для ASSERTION-шагов           | 3.2  | Средний              | Улучшает надежность и наблюдаемость асинхронных тестов.                         |
| **`TASK-2024-056`**               | **Эпик: Прогон наборов сценариев (SuiteRun)**      | 4    | **Средний**          | Важная функция для регрессионного тестирования и CI.                            |
| `TASK-2024-057` - `TASK-2024-060` | (Подзадачи SuiteRun)                               | 4.6  | Средний              | Декомпозиция основной задачи.                                                   |
| `TASK-2024-087`                   | Внедрение приоритетных очередей                    | 4.8  | Средний              | Улучшение `Scheduler` для лучшего UX.                                           |

### Приоритет: НИЗКИЙ (Продвинутые фичи и эксплуатация)

Эти задачи являются важными, но могут быть реализованы после того, как основной функционал будет готов и стабилизирован.

| ID Задачи                                                          | Название                                 | Фаза | Приоритет  | Rationale / Обоснование                                                                                                                            |
| :----------------------------------------------------------------- | :--------------------------------------- | :--- | :--------- | :------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`TASK-2024-061`**                                                | **Эпик: Зависимости между сценариями**   | 4    | **Низкий** | Продвинутая, сложная функциональность для сквозного тестирования. Требует наличия работающего `SuiteRunner`.                                       |
| `TASK-2024-062` - `TASK-2024-065`                                  | (Подзадачи зависимостей)                 | 4.7  | Низкий     | Декомпозиция.                                                                                                                                      |
| **Остальные AI-задачи**                                            | (AI-аналитика, AI-помощники)             | 4    | **Низкий** | Это "вишенки на торте", которые значительно улучшают UX, но не являются блокирующими. **Теперь они зависят от `TASK-2024-097` и `TASK-2024-098`.** |
| `TASK-2024-032`, `TASK-2024-039`, `TASK-2024-041`, `TASK-2024-066` |                                          |      |            |                                                                                                                                                    |
| **Задачи по оптимизации и эксплуатации**                           | (Retention, Observability, Partitioning) | 4    | **Низкий** | Критически важны для долгосрочной эксплуатации в production, но могут быть реализованы на завершающих этапах перед запуском.                       |
| `TASK-2024-029`, `TASK-2024-030`, `TASK-2024-096`                  |                                          |      |            |                                                                                                                                                    |
| **Прочие улучшения генератора**                                    | (Pairwise, 0-1-N, Scoring)               | 4    | **Низкий** | Продвинутые оптимизации для генератора сценариев.                                                                                                  |
| `TASK-2024-040`, `TASK-2024-091`, `TASK-2024-092`                  |                                          |      |            |                                                                                                                                                    |
