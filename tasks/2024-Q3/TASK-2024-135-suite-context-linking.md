---
id: TASK-2024-135
title: "Задача 4.10.12 (Backend): Иерархическая генерация данных для Suite (Summarize & Link)"
status: todo
priority: high
type: architecture
estimate: 20h
created: 2025-11-21
parents: [TASK-2024-037]
dependencies: [TASK-2024-134]
arch_refs: [ADR-0019, ADR-0022]
---

## Описание
При генерации данных для набора сценариев (Suite) необходимо обеспечить сквозную целостность данных (Referential Integrity) между сценариями, не перегружая контекстное окно LLM.

Реализуется подход **"Map-Reduce"**: сначала анализируем потребности каждого сценария, затем связываем их на глобальном уровне, и только потом генерируем детальные JSON.

## Алгоритм

1.  **Step 1: Scenario Summarization (Map)**
    *   Для каждого сценария в Suite вызываем AI (параллельно).
    *   **Цель:** Получить список `Requirements` (что нужно сценарию извне) и `Artifacts` (что сценарий порождает, что может быть полезно другим).
    *   *Пример:* Scen1 req: `user_login`, Scen2 req: `user_id`.

2.  **Step 2: Suite Linking (Reduce)**
    *   Агрегируем все `Requirements`.
    *   Вызываем AI-Архитектора: "Вот потребности 10 сценариев. Объедини дублирующиеся сущности в глобальные переменные Suite Scope."
    *   Резолвим эти глобальные переменные через `DataResolver` (БД).
    *   *Результат:* `SuiteContext = { "SHARED_USER": {...} }`.

3.  **Step 3: Context Injection & Generation**
    *   Вызываем генерацию для каждого сценария (используя логику из TASK-2024-136).
    *   **Важно:** Передаем `SuiteContext` как жесткие констрейнты.
    *   Если сценарий требует `user_id`, он берет его из `SuiteContext`, а не генерирует новый.

## Техническая реализация
*   Сервис `SuiteAnalysisService` в `ai-service`.
*   Новый промпт `suite_linker_prompt`.
*   Использование асинхронных `CompletableFuture` для параллельного анализа сценариев.

## Критерии приемки
- [ ] При генерации для Suite, где Scen1 создает заказ, а Scen2 его оплачивает, в обоих сценариях используется один и тот же `orderId` (или ссылка на него).
- [ ] Общие параметры (например, `Environment URL` или `Admin User`) генерируются один раз для всего Suite.